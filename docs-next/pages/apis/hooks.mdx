import { Markdown } from '../../components/Page';

# Hooks API

Hooks allow you to execute code at different stages of the mutation lifecycle when performing create, update, and delete operations.
Hooks can be defined either on both lists and fields.

Lists and fields both support the same set of hook functions, with some slight differences in the arguments they accept.
The differences will be explicitly called out below.

For examples of how to use hooks in your system please see the [hooks guide](../guides/hooks).

```typescript
import { config, createSchema, list } from '@keystone-next/keystone/schema';
import { text } from '@keystone-next/fields';

export default config({
  lists: createSchema({
    ListName: list({
      hooks: {
        // Hooks for create and update operations
        resolveInput: async args => { /* ... */ },
        validateInput: async args => { /* ... */ },
        beforeChange: async args => { /* ... */ },
        afterChange: async args => { /* ... */ },

        // Hooks for delete operations
        validateDelete: async args => { /* ... */ },
        beforeDelete: async args => { /* ... */ },
        afterDelete: async args => { /* ... */ },
      },
      fields: {
        fieldName: text({
          hooks: {
            // Hooks for create and update operations
            resolveInput: async args => { /* ... */ },
            validateInput: async args => { /* ... */ },
            beforeChange: async args => { /* ... */ },
            afterChange: async args => { /* ... */ },

            // Hooks for delete operations
            validateDelete: async args => { /* ... */ },
            beforeDelete: async args => { /* ... */ },
            afterDelete: async args => { /* ... */ },
          },
        }),
      },
    }),
  }),
});
```

### resolveInput

**Used to modify the `resolvedData`.**

- Invoked after access control and field defaults are applied
- Available for `create` and `update` operations

The return value of `resolveInput` should be the same structure as the `resolvedData`.
The result is passed to [the next function in the execution order](/docs/guides/hooks.md#execution-order).

#### Arguments

| Argument        | Type                    | Description                                                               |
| :-------------- | :---------------------- | :------------------------------------------------------------------------ |
| `operation`     | `String`                | The operation being performed (i.e. `create` or `update`)                  |
| `existingItem`  | `Object` or `undefined` | The current stored item (or `undefined` for `create` operations)          |
| `originalInput` | `Object`                | The data received by the GraphQL mutation                                 |
| `resolvedData`  | `Object`                | The data received by the GraphQL mutation plus defaults values            |
| `context`       | `KeystoneContext`       | The [`KeystoneContext`](./context) for this request                       |
| `listKey`       | `String`                | The key for the list being operated on                                    |
| `fieldPath`     | `String`                | The path for the field being operated on (applicable to field hooks only) |

#### Usage

```typescript
const resolveInput = async ({
  operation,
  existingItem,
  originalInput,
  resolvedData,
  context,
  listKey,
  fieldPath, // Field hooks only
}) => {
  // Input resolution logic. Object returned is used in place of `resolvedData`.
  return resolvedData;
};
```

### validateInput

**Used to verify the `resolvedData` is valid.**

- Invoked after all `resolveInput` hooks have resolved
- Available for `create` and `update` operations

If errors are found in `resolvedData` the function should either throw or call the supplied `addFieldValidationError` argument.
Return values are ignored.

#### Arguments

| Argument                  | Type                    | Description                                                                               |
| :------------------------ | :---------------------- | :---------------------------------------------------------------------------------------- |
| `operation`               | `String`                | The operation being performed (i.e. `create` or `update`)                                  |
| `existingItem`            | `Object` or `undefined` | The current stored item (or `undefined` for `create` operations)                          |
| `originalInput`           | `Object`                | The data received by the GraphQL mutation                                                 |
| `resolvedData`            | `Object`                | The data received by the GraphQL mutation plus defaults values                            |
| `context`                 | `KeystoneContext`       | The [`KeystoneContext`](./context) for this request                                       |
| `addFieldValidationError` | `Function`              | Used to set a field validation error (applicable to field hooks only); accepts a `String` |
| `addValidationError`      | `Function`              | Used to set a validation error (applicable to list hooks only); accepts a `String`        |
| `listKey`                 | `String`                | The key for the list being operated on                                                    |
| `fieldPath`               | `String`                | The path for the field being operated on (applicable to field hooks only)                 |

#### Usage

```typescript
const validateInput = ({
  operation,
  existingItem,
  originalInput,
  resolvedData,
  context,
  addFieldValidationError, // Field hooks only
  addValidationError, // List hooks only
  listKey,
  fieldPath, // Field hooks only
}) => {
  // Throw error objects or register validation errors with addFieldValidationError(<String>)
  // Return values ignored
};
```

### beforeChange

**Used to cause side effects before the primary operation is executed.**

- Invoked after all `validateInput` hooks have resolved
- Available for `create` and `update` operations

`beforeChange` hooks can't manipulate the data passed to the primary operation but perform operations before data is saved.
Return values are ignored.

#### Arguments

| Argument        | Type                    | Description                                                               |
| :-------------- | :---------------------- | :------------------------------------------------------------------------ |
| `operation`     | `String`                | The operation being performed (i.e. `create` or `update`)                  |
| `existingItem`  | `Object` or `undefined` | The current stored item (or `undefined` for `create` operations)          |
| `originalInput` | `Object`                | The data received by the GraphQL mutation                                 |
| `resolvedData`  | `Object`                | The data received by the GraphQL mutation plus defaults values            |
| `context`       | `KeystoneContext`       | The [`KeystoneContext`](./context) for this request                       |
| `listKey`       | `String`                | The key for the list being operated on                                    |
| `fieldPath`     | `String`                | The path for the field being operated on (applicable to field hooks only) |

#### Usage

```typescript
const beforeChange = async ({
  operation,
  existingItem,
  originalInput,
  resolvedData,
  context,
  listKey,
  fieldPath, // Field hooks only
}) => {
  // Perform side effects
  // Return values ignored
};
```

### afterChange

**Used to cause side effects after the primary operation is executed.**

- Invoked after the primary operation has completed
- Available for `create` and `update` operations

`afterChange` hooks perform actions after data is saved.
It receives both the "pre-update" item that was stored (`existingItem`) and the resultant, "post-update" item data (`updatedItem`).
This includes any DB-level defaults.
Notably, for `create` operations, this includes the item's `id`.

Return values are ignored.

#### Arguments

| Argument        | Type                    | Description                                                               |
| :-------------- | :---------------------- | :------------------------------------------------------------------------ |
| `operation`     | `String`                | The operation being performed (i.e. `create` or `update`)                  |
| `existingItem`  | `Object` or `undefined` | The previously stored item (or `undefined` for `create` operations)       |
| `originalInput` | `Object`                | The data received by the GraphQL mutation                                 |
| `updatedItem`   | `Object`                | The new/currently stored item                                             |
| `context`       | `KeystoneContext`       | The [`KeystoneContext`](./context) for this request                       |
| `listKey`       | `String`                | The key for the list being operated on                                    |
| `fieldPath`     | `String`                | The path for the field being operated on (applicable to field hooks only) |

#### Usage

```typescript
const afterChange = async ({
  operation,
  existingItem,
  originalInput,
  updatedItem,
  context,
  listKey,
  fieldPath, // Field hooks only
}) => {
  // Perform side effects
  // Return values ignored
};
```

### validateDelete

**Used to verify a delete operation is valid**, i.e. will maintain data consitency.

- Invoked after access control has been tested
- Available for `delete` operations

Should throw or register errors with `addFieldValidationError(<String>)` if the delete operation is invalid.

#### Arguments

| Argument                  | Type              | Description                                                                               |
| :------------------------ | :---------------- | :---------------------------------------------------------------------------------------- |
| `operation`               | `String`          | The operation being performed (`delete` in this case)                                     |
| `existingItem`            | `Object`          | The current stored item                                                                   |
| `context`                 | `KeystoneContext` | The [`KeystoneContext`](./context) for this request                                       |
| `addFieldValidationError` | `Function`        | Used to set a field validation error (applicable to field hooks only); accepts a `String` |
| `addValidationError`      | `Function`        | Used to set a validation error (applicable to list hooks only); accepts a `String`        |
| `listKey`                 | `String`          | The key for the list being operated on                                                    |
| `fieldPath`               | `String`          | The path for the field being operated on (applicable to field hooks only)                 |

#### Usage

```typescript
const validateDelete = async ({
  operation,
  existingItem,
  context,
  addFieldValidationError, // Field hooks only
  addValidationError, // List hooks only
  listKey,
  fieldPath, // Field hooks only
}) => {
  // Throw error objects or register validation errors with addFieldValidationError(<String>)
  // Return values ignored
};
```

### beforeDelete

**Used to cause side effects before the delete operation is executed.**

- Invoked after all `validateDelete` hooks have resolved
- Available for `delete` operations

Perform actions before the delete operation is executed.
Return values are ignored.

#### Arguments

| Argument       | Type              | Description                                                               |
| :------------- | :---------------- | :------------------------------------------------------------------------ |
| `operation`    | `String`          | The operation being performed (`delete` in this case)                     |
| `existingItem` | `Object`          | The current stored item                                                   |
| `context`      | `KeystoneContext` | The [`KeystoneContext`](./context) for this request                       |
| `listKey`      | `String`          | The key for the list being operated on                                    |
| `fieldPath`    | `String`          | The path for the field being operated on (applicable to field hooks only) |

#### Usage

```typescript
const beforeDelete = async ({
  operation,
  existingItem,
  context,
  listKey,
  fieldPath, // Field hooks only
}) => {
  // Perform side effects
  // Return values ignored
};
```

### afterDelete

**Used to cause side effects after the delete operation is executed.**

- Invoked after the delete operation has been executed
- Available for `delete` operations

Perform actions after the delete operation has been executed.
This is the last chance to operate on the previously stored item, supplied as `existingItem`.

Return values are ignored.

#### Arguments

| Argument       | Type              | Description                                                               |
| :------------- | :---------------- | :------------------------------------------------------------------------ |
| `operation`    | `String`          | The operation being performed (`delete` in this case)                     |
| `existingItem` | `Object`          | The previously stored item, now deleted                                   |
| `context`      | `KeystoneContext` | The [`KeystoneContext`](./context) for this request                       |
| `listKey`      | `String`          | The key for the list being operated on                                    |
| `fieldPath`    | `String`          | The path for the field being operated on (applicable to field hooks only) |

#### Usage

```typescript
const afterDelete = async ({
  operation,
  existingItem,
  context,
  listKey,
  fieldPath, // Field hooks only
}) => {
  // Perform side effects
  // Return values ignored
};
```

export default ({ children }) => <Markdown>{children}</Markdown>;
