import { Markdown } from '../../components/Page';

# Hooks API

Hooks allow you to execute code at different stages of the mutation lifecycle when performing create, update, and delete operations.
Hooks can be defined either on both lists and fields.

Lists and fields both support the same set of hook functions, with some slight differences in the arguments they accept.
The differences will be explicitly called out below.

For examples of how to use hooks in your system please see the [hooks guide](../guides/hooks).

```typescript
import { config, createSchema, list } from '@keystone-next/keystone/schema';
import { text } from '@keystone-next/fields';

export default config({
  lists: createSchema({
    ListName: list({
      hooks: {
        // Hooks for create and update operations
        resolveInput: async args => {
          /* ... */
        },
        validateInput: async args => {
          /* ... */
        },
        beforeChange: async args => {
          /* ... */
        },
        afterChange: async args => {
          /* ... */
        },

        // Hooks for delete operations
        validateDelete: async args => {
          /* ... */
        },
        beforeDelete: async args => {
          /* ... */
        },
        afterDelete: async args => {
          /* ... */
        },
      },
      fields: {
        fieldName: text({
          hooks: {
            // Hooks for create and update operations
            resolveInput: async args => {
              /* ... */
            },
            validateInput: async args => {
              /* ... */
            },
            beforeChange: async args => {
              /* ... */
            },
            afterChange: async args => {
              /* ... */
            },

            // Hooks for delete operations
            validateDelete: async args => {
              /* ... */
            },
            beforeDelete: async args => {
              /* ... */
            },
            afterDelete: async args => {
              /* ... */
            },
          },
        }),
      },
    }),
  }),
});
```

### resolveInput

The `resolveInput` function is used to modify or augment the `data` values passed in to a `create` or `update` operation.

**Used to modify the `resolvedData`.**

- Invoked after access control and field defaults are applied
- Available for `create` and `update` operations

The return value of `resolveInput` should be the same structure as the `resolvedData`.
The result is passed to [the next function in the execution order](/docs/guides/hooks.md#execution-order).

#### Arguments

| Argument        | Description                                                               |
| :-------------- | :------------------------------------------------------------------------ |
| `operation`     | The CRU operation being performed (`'create'`, `'update'`, `'delete'`)    |
| `existingItem`  | The current stored item (or `undefined` for `create` operations)          |
| `originalInput` | The data received by the GraphQL mutation                                 |
| `resolvedData`  | The data received by the GraphQL mutation plus defaults values            |
| `context`       | The [`KeystoneContext`](./context) for this request                       |
| `listKey`       | The key for the list being operated on                                    |
| `fieldPath`     | The path for the field being operated on (applicable to field hooks only) |

#### Usage

```typescript
const resolveInput = async ({
  operation,
  existingItem,
  originalInput,
  resolvedData,
  context,
  listKey,
  fieldPath, // Field hooks only
}) => {
  // Input resolution logic. Object returned is used in place of `resolvedData`.
  return resolvedData;
};
```

### validateInput

The `validateInput` function is used to validate the `data` values passed in to a `create` or `update` operation.

**Used to verify the `resolvedData` is valid.**

- Invoked after all `resolveInput` hooks have resolved
- Available for `create` and `update` operations

If errors are found in `resolvedData` the function should either throw or call the supplied `addFieldValidationError` argument.
Return values are ignored.

#### Arguments

| Argument                  | Description                                                                               |
| :------------------------ | :---------------------------------------------------------------------------------------- |
| `operation`               | The CRU operation being performed (`'create'`, `'update'`, `'delete'`)                    |
| `existingItem`            | The current stored item (or `undefined` for `create` operations)                          |
| `originalInput`           | The data received by the GraphQL mutation                                                 |
| `resolvedData`            | The data received by the GraphQL mutation plus defaults values                            |
| `context`                 | The [`KeystoneContext`](./context) for this request                                       |
| `addFieldValidationError` | Used to set a field validation error (applicable to field hooks only); accepts a `String` |
| `addValidationError`      | Used to set a validation error (applicable to list hooks only); accepts a `String`        |
| `listKey`                 | The key for the list being operated on                                                    |
| `fieldPath`               | The path for the field being operated on (applicable to field hooks only)                 |

#### Usage

```typescript
const validateInput = ({
  operation,
  existingItem,
  originalInput,
  resolvedData,
  context,
  addFieldValidationError, // Field hooks only
  addValidationError, // List hooks only
  listKey,
  fieldPath, // Field hooks only
}) => {
  // Throw error objects or register validation errors with addFieldValidationError(<String>)
  // Return values ignored
};
```

### beforeChange

The `beforeChange` function is used to perform side effects just before the data for a `create` or `update` operation is saved to the database.

**Used to cause side effects before the primary operation is executed.**

- Invoked after all `validateInput` hooks have resolved
- Available for `create` and `update` operations

`beforeChange` hooks can't manipulate the data passed to the primary operation but perform operations before data is saved.
Return values are ignored.

#### Arguments

| Argument        | Description                                                               |
| :-------------- | :------------------------------------------------------------------------ |
| `operation`     | The CRU operation being performed (`'create'`, `'update'`, `'delete'`)    |
| `existingItem`  | The current stored item (or `undefined` for `create` operations)          |
| `originalInput` | The data received by the GraphQL mutation                                 |
| `resolvedData`  | The data received by the GraphQL mutation plus defaults values            |
| `context`       | The [`KeystoneContext`](./context) for this request                       |
| `listKey`       | The key for the list being operated on                                    |
| `fieldPath`     | The path for the field being operated on (applicable to field hooks only) |

#### Usage

```typescript
const beforeChange = async ({
  operation,
  existingItem,
  originalInput,
  resolvedData,
  context,
  listKey,
  fieldPath, // Field hooks only
}) => {
  // Perform side effects
  // Return values ignored
};
```

### afterChange

The `afterChange` function is used to perform side effects just after the data for a `create` or `update` operation is saved to the database.

**Used to cause side effects after the primary operation is executed.**

- Invoked after the primary operation has completed
- Available for `create` and `update` operations

`afterChange` hooks perform actions after data is saved.
It receives both the "pre-update" item that was stored (`existingItem`) and the resultant, "post-update" item data (`updatedItem`).
This includes any DB-level defaults.
Notably, for `create` operations, this includes the item's `id`.

Return values are ignored.

#### Arguments

| Argument        | Description                                                               |
| :-------------- | :------------------------------------------------------------------------ |
| `operation`     | The CRU operation being performed (`'create'`, `'update'`, `'delete'`)    |
| `existingItem`  | The previously stored item (or `undefined` for `create` operations)       |
| `originalInput` | The data received by the GraphQL mutation                                 |
| `updatedItem`   | The new/currently stored item                                             |
| `context`       | The [`KeystoneContext`](./context) for this request                       |
| `listKey`       | The key for the list being operated on                                    |
| `fieldPath`     | The path for the field being operated on (applicable to field hooks only) |

#### Usage

```typescript
const afterChange = async ({
  operation,
  existingItem,
  originalInput,
  updatedItem,
  context,
  listKey,
  fieldPath, // Field hooks only
}) => {
  // Perform side effects
  // Return values ignored
};
```

### validateDelete

The `validateDelete` function is used to validate the `data` values passed in to a `delete` operation.

**Used to verify a delete operation is valid**, i.e. will maintain data consitency.

- Invoked after access control has been tested
- Available for `delete` operations

Should throw or register errors with `addFieldValidationError(<String>)` if the delete operation is invalid.

#### Arguments

| Argument                  | Description                                                                               |
| :------------------------ | :---------------------------------------------------------------------------------------- |
| `operation`               | The CRU operation being performed ( `'delete'`)                                           |
| `existingItem`            | The current stored item                                                                   |
| `context`                 | The [`KeystoneContext`](./context) for this request                                       |
| `addFieldValidationError` | Used to set a field validation error (applicable to field hooks only); accepts a `String` |
| `addValidationError`      | Used to set a validation error (applicable to list hooks only); accepts a `String`        |
| `listKey`                 | The key for the list being operated on                                                    |
| `fieldPath`               | The path for the field being operated on (applicable to field hooks only)                 |

#### Usage

```typescript
const validateDelete = async ({
  operation,
  existingItem,
  context,
  addFieldValidationError, // Field hooks only
  addValidationError, // List hooks only
  listKey,
  fieldPath, // Field hooks only
}) => {
  // Throw error objects or register validation errors with addFieldValidationError(<String>)
  // Return values ignored
};
```

### beforeDelete

The `beforeDelete` function is used to perform side effects just before the data for a `delete` operation is saved to the database.

**Used to cause side effects before the delete operation is executed.**

- Invoked after all `validateDelete` hooks have resolved
- Available for `delete` operations

Perform actions before the delete operation is executed.
Return values are ignored.

#### Arguments

| Argument       | Description                                                               |
| :------------- | :------------------------------------------------------------------------ |
| `operation`    | The CRU operation being performed ( `'delete'`)                           |
| `existingItem` | The current stored item                                                   |
| `context`      | The [`KeystoneContext`](./context) for this request                       |
| `listKey`      | The key for the list being operated on                                    |
| `fieldPath`    | The path for the field being operated on (applicable to field hooks only) |

#### Usage

```typescript
const beforeDelete = async ({
  operation,
  existingItem,
  context,
  listKey,
  fieldPath, // Field hooks only
}) => {
  // Perform side effects
  // Return values ignored
};
```

### afterDelete

The `afterDelete` function is used to perform side effects just after the data for a `create` or `update` operation is saved to the database.

**Used to cause side effects after the delete operation is executed.**

- Invoked after the delete operation has been executed
- Available for `delete` operations

Perform actions after the delete operation has been executed.
This is the last chance to operate on the previously stored item, supplied as `existingItem`.

Return values are ignored.

#### Arguments

| Argument       | Description                                                               |
| :------------- | :------------------------------------------------------------------------ |
| `operation`    | The CRU operation being performed (`'delete'`)                            |
| `existingItem` | The previously stored item, now deleted                                   |
| `context`      | The [`KeystoneContext`](./context) for this request                       |
| `listKey`      | The key for the list being operated on                                    |
| `fieldPath`    | The path for the field being operated on (applicable to field hooks only) |

#### Usage

```typescript
const afterDelete = async ({
  operation,
  existingItem,
  context,
  listKey,
  fieldPath, // Field hooks only
}) => {
  // Perform side effects
  // Return values ignored
};
```

export default ({ children }) => <Markdown>{children}</Markdown>;
