import { Markdown } from '../../components/Page';

# Context API

The `KeystoneContext` type represents an [Apollo Server context](https://www.apollographql.com/docs/apollo-server/data/resolvers/#the-context-argument) object.
A `KeystoneContext` object is made available to many of the server-side functions in a Keystone system.
It contains the APIs required to write the business logic for things like [access control](../guides/access-control), [hooks](../guides/hooks), [testing](../guides/testing) and GraphQL [schema extensions](../guides/schema-extension).

```typescript
import type { KeystoneContext } from '@keystone-next/types';

context = {
  // HTTP request object
  req,

  // List item API
  lists,

  // GraphQL helpers
  graphql: {
    schema,
    run,
    raw,
  };

  // Session API
  session,
  startSession,
  endSession,

  // New context creators
  sudo,
  exitSudo,
  withSession,

  // Database access
  knex,
  prisma,
  mongoose,

  // Access control helpers
  getListAccessControlForUser,
  getFieldAccessControlForUser,

  // Internal state
  totalResults,
  maxTotalResults,
  schemaName,

  // Deprecated
  gqlNames,
  executeGraphQL,
  keystone,
};
```

### HTTP request object

`req`: The [IncomingMessage](https://nodejs.org/api/http.html#http_class_http_incomingmessage) object from the HTTP request which called the GraphQL API.

### List item API

`lists`: The [list items API](./list-items), which can be used to perform CRUD operations against your GraphQL API.

### GraphQL helpers

`graphql.schema`: The [GraphQL Schema](https://graphql.org/graphql-js/type/#graphqlschema) object, which can be used directly, or via `graphql.raw`, `graphql.run`, or the `lists` API.

`graphql.raw`: An async function which takes `({ query, variables })` and executes the query against the GraphQL schema, returning `{ data, errors }`.
`query` can be either a string or a GraphQL [`Document`](https://graphql.org/graphql-js/language/#parse).
`variables` is an optional object containing the input variables for the query.
The returned object is an [`ExecutionResult`](https://graphql.org/graphql-js/execution/).
This query uses the current `context` object as its `context`.

`graphql.run`: An async function which takes `({ query, variables })` and executes the query against the GraphQL schema, returning `data`.
`query` can be either a string or a GraphQL [`Document`](https://graphql.org/graphql-js/language/#parse).
`variables` is an optional object containing the input variables for the query.
The returned object is an [`ExecutionResult.data`](https://graphql.org/graphql-js/execution/).
Any errors generated by the query will be thrown as an exception.
This query uses the current `context` object as its `context`.

### Session API

If you configure your Keystone system with session management then you will have access to the following properties.
See the [session API](./session#session-context) for more details.

`session`: The current session data object.

`startSession`: An internal helper function used by authentication mutations to start a session on a successful login. This should not be called directly.

`endSession`: An internal helper function used by authentication mutations to end a session on logout. This should not be called directly.

### New context creators

When using the `context.lists`, `context.graphql.run`, and `context.graphql.raw` APIs, access control and session information is passed through to these calls from the `context` object.
The following functions will create a new `KeystoneContext` object with this behaviour modified.

`context.sudo()` returns a new `KeystoneContext` object with all access control disabled for subsequent API calls.

`context.exitSudo()` returns a new `KeystoneContext` object with all access control re-enabled for subsequent API calls.

`context.withSession(newSession)` returns a new `KeystoneContext` object with the `.session` object replaced with `newSession`.

### Database access

The `KeystoneContext` object exposes the underlying database driver directly, depending on the value of [`config.db.adapter`](http://localhost:8000/apis/config#db).

If `config.db.adapter === 'prisma_postgresql'`, then `context.prisma` will be a [Prisma Client](https://www.prisma.io/docs/reference/api-reference/prisma-client-reference) object.

If `config.db.adapter === 'knex'`, then `context.knex` will be a [Knex connection](http://knexjs.org/) object.

if `config.db.adapter === 'mongoose'`, then `context.mongoose` will be a [Mongoose](https://mongoosejs.com/docs/api/mongoose.html) object.

### Access control helpers

The functions `getListAccessControlForUser()` and `getFieldAccessControlForUser()` are used by the internal Keystone resolvers to apply access control.
They should not be called directly.

### Internal state

These properties are used internally by Keystone and generally do not need to be directly accessed.

`totalResults`: The cumulative total number of results returned by the current request. See [`config.graphql.queryLimits`](./config#graphql).

`maxTotalResults`: The maximum number of results which can be returned before a query limit error is triggered. See [`config.graphql.queryLimits`](./apis/config#graphql).

`schemaName`: The internal name used by Keystone to refer to the GraphQL schema.

### Deprecated

The following properties are deprecated and should not be used.
They will be removed in future releases.

`gqlNames`: A function which takes a `listKey` and returns an object containing the GraphQL query, mutation and type names related to that list.

`executeGraphQL`: This function is identical to `context.graphql.raw`, which is the preferred API to use.

`keystone`: An object representing the internal state of the system.

export default ({ children }) => <Markdown>{children}</Markdown>;
